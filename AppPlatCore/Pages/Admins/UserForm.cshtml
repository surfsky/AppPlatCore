@page
@model App.Pages.Admin.UserFormModel
@{
    ViewData["Title"] = "User";
}

@section body {

    <f:Panel ID="Panel1" ShowBorder="false" ShowHeader="false" AutoScroll="true" IsViewPort="true" Layout="VBox">
        <Items>
            <f:Form ID="SimpleForm1" ShowBorder="false" ShowHeader="false" BodyPadding="10" Enabled="@Model.Mode != PageMode.View ">
                <Toolbars>
                    <f:Toolbar ID="Toolbar1">
                        <Items>
                            <f:Button ID="btnClose" Icon="SystemClose" Text="关闭" OnClientClick="F.activeWindow.hide();" />
                            <f:Button ID="btnSaveClose" Text="保存后关闭" Icon="SystemSaveClose" ValidateForms="SimpleForm1" 
                                OnClick="@Url.Handler("UserEdit_btnSaveClose_Click")" 
                                OnClickFields="SimpleForm1"
                                OnClickParameter1="@(new Parameter("imgPhotoUrl", "F.ui.imgPhoto.el.find('img').attr('src')"))"
                                />
                        </Items>
                    </f:Toolbar>
                </Toolbars>
                <Rows>
                    <f:FormRow>
                        <Items>
                            <f:HiddenField For="CurrentUser.ID" />
                            <f:TextBox For="CurrentUser.Name" />
                            <f:TextBox For="CurrentUser.ChineseName" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:RadioButtonList For="CurrentUser.Gender">
                                <f:RadioItem Text="男" Value="男" />
                                <f:RadioItem Text="女" Value="女" />
                            </f:RadioButtonList>
                            <f:CheckBox For="CurrentUser.Enabled" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TextBox For="CurrentUser.Password" TextMode="Password" Hidden="@Model.Mode == PageMode.New" />
                            <f:Label />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TextBox For="CurrentUser.Email" RegexPattern="EMAIL" />
                            <f:TextBox For="CurrentUser.CompanyEmail" RegexPattern="EMAIL" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TextBox For="CurrentUser.OfficePhone" />
                            <f:TextBox For="CurrentUser.OfficePhoneExt" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TextBox For="CurrentUser.HomePhone" />
                            <f:TextBox For="CurrentUser.CellPhone" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TextBox For="CurrentUser.Title" />
                            <f:TextBox For="CurrentUser.Remark" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TwinTriggerBox ID="tbSelectedRole" EnableEdit="false" Text="@Model.SelectedRoleNames"
                                Trigger1Icon="Clear" Trigger2Icon="Search" ShowTrigger1="false" ShowTrigger2="true" Label="所属角色"
                                OnClientTrigger1Click="onSelectedRoleTrigger1Click();"
                                OnClientTrigger2Click="onSelectedRoleTrigger2Click();"
                                />
                            <f:HiddenField ID="hfSelectedRole" Text="@Model.SelectedRoleIDs" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:TwinTriggerBox ID="tbSelectedDept" EnableEdit="false" Text="@Model.SelectedDeptName"
                                Trigger1Icon="Clear" Trigger2Icon="Search" ShowTrigger1="false" ShowTrigger2="true" Label="所属部门"
                                OnClientTrigger1Click="onSelectedDeptTrigger1Click();"
                                OnClientTrigger2Click="onSelectedDeptTrigger2Click();"
                                />
                            <f:HiddenField ID="hfSelectedDept" Text="@Model.SelectedDeptID" />
                        </Items>
                    </f:FormRow>
                    <f:FormRow>
                        <Items>
                            <f:Image For="CurrentUser.Photo" ID="imgPhoto" CssClass="photo" ImageUrl="@Model.CurrentUser?.Photo" ShowEmptyLabel="true" Label="头像" />
                            <f:FileUpload ID="filePhoto" ShowRedStar="false" ShowEmptyLabel="true" ButtonText="上传个人头像" ButtonOnly="true" Required="false" ButtonIcon="ImageAdd" 
                                OnFileSelected="@Url.Handler("filePhoto_FileSelected")" OnFileSelectedFields="filePhoto"  />
                        </Items>
                    </f:FormRow>
                </Rows>
            </f:Form>
        </Items>
    </f:Panel>

    <f:Window ID="Window1" Title="编辑" Hidden="true" EnableIFrame="true"
        EnableMaximize="true" EnableResize="true" Target="Top" IsModal="true" Width="550"
        Height="350"
        />

}


@section script {

    <script>
        //--------------------------------------------------
        // Init
        //--------------------------------------------------
        F.ready(function () {
            checkSelectedRoleTriggerStatus();
            checkSelectedDeptTriggerStatus();
        });


        //--------------------------------------------------
        // Role
        //--------------------------------------------------
        function checkSelectedRoleTriggerStatus() {
            if (F.ui.tbSelectedRole.getValue()) {
                F.ui.tbSelectedRole.showTrigger1();
            } else {
                F.ui.tbSelectedRole.hideTrigger1();
            }
        }

        function onSelectedRoleTrigger1Click() {
            F.ui.tbSelectedRole.setValue('');
            F.ui.hfSelectedRole.setValue('');
            checkSelectedRoleTriggerStatus();
        }

        function onSelectedRoleTrigger2Click() {
            F.ui.Window1.show(F.baseUrl + 'Admin/UserSelectRole?ids=' + F.ui.hfSelectedRole.getValue(), '选择用户所属的角色');
        }

        function updateSelectedRole(roleNames, roleIDs) {
            F.ui.tbSelectedRole.setValue(roleNames);
            F.ui.hfSelectedRole.setValue(roleIDs);
            checkSelectedRoleTriggerStatus();
        }

        //--------------------------------------------------
        // Dept
        //--------------------------------------------------
        function checkSelectedDeptTriggerStatus() {
            if (F.ui.tbSelectedDept.getValue()) {
                F.ui.tbSelectedDept.showTrigger1();
            } else {
                F.ui.tbSelectedDept.hideTrigger1();
            }
        }

        function onSelectedDeptTrigger1Click() {
            F.ui.tbSelectedDept.setValue('');
            F.ui.hfSelectedDept.setValue('');
            checkSelectedDeptTriggerStatus();
        }

        function onSelectedDeptTrigger2Click() {
            F.ui.Window1.show(F.baseUrl + 'admin/UserSelectDept?ids=' + F.ui.hfSelectedDept.getValue(), '选择用户所属的部门');
        }

        function updateSelectedDept(deptName, deptID) {
            F.ui.tbSelectedDept.setValue(deptName);
            F.ui.hfSelectedDept.setValue(deptID);
            checkSelectedDeptTriggerStatus();
        }


    </script>

}

